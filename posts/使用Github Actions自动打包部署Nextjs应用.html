<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/Z.svg"/><meta name="description" content="Welcome to Zhang Shumeng`s Blog"/><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-24/clipboard-9882.d0bc97.webp"/><meta name="og:title" content="Zhang Shumeng`s Blog"/><meta name="twitter:card" content="summary_large_image"/><link rel="preload" as="image" href="/Z.svg"/><title>使用Github Actions自动打包部署NextJS应用</title><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/0980fb410332472e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0980fb410332472e.css" data-n-g=""/><link rel="preload" href="/_next/static/css/3cf2d9b0cda59a28.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3cf2d9b0cda59a28.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-b8f8d6679aaa5f42.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-218004e7d27ded15.js" defer=""></script><script src="/_next/static/chunks/pages/_app-aef446c81fd4cad4.js" defer=""></script><script src="/_next/static/chunks/567-75104bd437223d69.js" defer=""></script><script src="/_next/static/chunks/327-84b3593cabc892c0.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-217addf3f9be560f.js" defer=""></script><script src="/_next/static/_zcP27D7eUYWJvFDlI-DM/_buildManifest.js" defer=""></script><script src="/_next/static/_zcP27D7eUYWJvFDlI-DM/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="layout_container__fbLkO"><header class="layout_header__kY0Lt"><div style="position:fixed;top:0;left:0;height:.25rem;width:100%;background-color:rgb(99 102 241);transform:translateX(-100%);transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s"></div><a href="/"><img alt="Zhang Shumeng" width="108" height="108" decoding="async" data-nimg="1" class="utils_borderCircle__s2nTm" style="color:transparent" src="/Z.svg"/></a><h2 class="utils_headingLg__5535D"><a class="utils_colorInherit__mSH_x" href="/">Zhang Shumeng</a></h2></header><main><article><h1 class="utils_headingXl__u25Y2">使用Github Actions自动打包部署NextJS应用</h1><div class="utils_lightText__eUzGY"><time dateTime="2023-02-25">2023年02月25日</time></div><div><p>打包部署博客是一个重复机械的劳动，因此我想到使用 <strong>Github Actions</strong> 自动化整个流程。虽然有各种现成的Actions仓库，但对于第一次使用的我来说还是遇到了一些问题，在此记录一下。</p>
<p><strong>目标</strong></p>
<ul>
<li>自动部署NextJS应用到Github Pages</li>
<li>源代码提交在私有仓库中，打包推送到username.github.io公开仓库</li>
<li>私有仓库main分支上的push操作触发action</li>
</ul>
<p><strong>创建actions</strong></p>
<p>在项目根目录中新建<code>.github/workflows</code>目录，并新建deploy.yml相应操作代码在该文件中编写，GitHub会执行workflows目录下的所有文件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-7290.c04546.webp" alt=""></p>
<p><strong>使用到的Actions仓库</strong></p>
<p><a href="https://github.com/peaceiris/actions-gh-pages">actions-gh-pages</a></p>
<p>该仓库中包含不同框架项目的使用示例</p>
<p>⭐️ React and Next</p>
<pre><code>name: GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '14'

      - name: Get yarn cache
        id: yarn-cache
        run: echo "YARN_CACHE_DIR=$(yarn cache dir)" >> "${GITHUB_OUTPUT}"

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.yarn-cache.outputs.YARN_CACHE_DIR }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - run: yarn install --frozen-lockfile
      - run: yarn build
      - run: yarn export

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.ref == 'refs/heads/main' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
</code></pre>
<p>上述示例实现打包NextJS应用到运行此action的仓库中，默认推送到gh-pages分支（通过publish_branch选项修改推送分支）。</p>
<p>因此实现推送到其他仓库需要修改部分代码</p>
<pre><code>      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }}
          external_repository: username/username.github.io
          publish_branch: main
          publish_dir: ./out // 推送该指定目录下的文件
          commit_message: ${{ github.event.head_commit.message }}
</code></pre>
<ul>
<li><code>personal_token</code> 个人令牌</li>
<li><code>external_repository</code> 其他仓库的地址</li>
<li><code>publish_dir</code> 推送该目录下的文件</li>
<li><code>commit_message</code> 自定义commit信息</li>
</ul>
<p>注意<code>GITHUB TOKEN</code>没有访问外部存储库的权限。请创建一个个人访问令牌，并将其设置为secrets，如<code>personal_token: ${{ secrets.PERSONAL_TOKEN }}</code>。</p>
<p><strong>创建个人令牌</strong></p>
<ul>
<li>点击github页面右上角的个人头像，点击Settings</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-6532.3bbea5.webp" alt=""></p>
<ul>
<li>点击Developer settings</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-3950.aca4dd.webp" alt=""></p>
<ul>
<li>选择页面右下角的Tokens(classic)，点击Generate new token(classic)</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-7333.68b538.webp" alt=""></p>
<ul>
<li>填写备注信息，选择有效时长，<strong>勾选repo</strong>，然后点击下方的Generate token按钮，生成token并复制</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-4107.c474f1.webp" alt=""></p>
<p><strong>将生成的个人令牌绑定到项目的secrets</strong></p>
<ul>
<li>打开运行action的仓库，依次点击Settings->Actions-> New repository secret</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-4506.428fe9.webp" alt=""></p>
<ul>
<li>Name输入<code>personal_token</code>，Secret粘贴生成的个人令牌，点击Add secret</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-7782.8ec4d7.webp" alt=""></p>
<p>通过上面的配置，我们就可以在action中通过<code>${{ secrets.PERSONAL_TOKEN }}</code>访问到个人令牌</p>
<p>最后将新建的<code>deploy.yml</code>文件提交推送到远程仓库，就会自动触发action执行，构建打包我们的NextJS应用并推送到<code>external_repository</code>对应仓库的<code>publish_branch</code>对应的分支中</p>
<p>可以在仓库的Actions中查看action的执行过程，完成后打开GitHub Pages对应的仓库就能看到新提交的代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-6478.66382d.webp" alt=""></p>
<p>以上就是本文的全部内容，感谢阅读。</p>
</div></article></main><div class="layout_backToHome__9sjx_"><a href="/">← 返回首页</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"使用Github Actions自动打包部署Nextjs应用","contentHtml":"\u003cp\u003e打包部署博客是一个重复机械的劳动，因此我想到使用 \u003cstrong\u003eGithub Actions\u003c/strong\u003e 自动化整个流程。虽然有各种现成的Actions仓库，但对于第一次使用的我来说还是遇到了一些问题，在此记录一下。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e目标\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e自动部署NextJS应用到Github Pages\u003c/li\u003e\n\u003cli\u003e源代码提交在私有仓库中，打包推送到username.github.io公开仓库\u003c/li\u003e\n\u003cli\u003e私有仓库main分支上的push操作触发action\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e创建actions\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e在项目根目录中新建\u003ccode\u003e.github/workflows\u003c/code\u003e目录，并新建deploy.yml相应操作代码在该文件中编写，GitHub会执行workflows目录下的所有文件。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-7290.c04546.webp\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e使用到的Actions仓库\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/peaceiris/actions-gh-pages\"\u003eactions-gh-pages\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e该仓库中包含不同框架项目的使用示例\u003c/p\u003e\n\u003cp\u003e⭐️ React and Next\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ename: GitHub Pages\r\n\r\non:\r\n  push:\r\n    branches:\r\n      - main\r\n  pull_request:\r\n\r\njobs:\r\n  deploy:\r\n    runs-on: ubuntu-22.04\r\n    permissions:\r\n      contents: write\r\n    concurrency:\r\n      group: ${{ github.workflow }}-${{ github.ref }}\r\n    steps:\r\n      - uses: actions/checkout@v3\r\n\r\n      - name: Setup Node\r\n        uses: actions/setup-node@v3\r\n        with:\r\n          node-version: '14'\r\n\r\n      - name: Get yarn cache\r\n        id: yarn-cache\r\n        run: echo \"YARN_CACHE_DIR=$(yarn cache dir)\" \u003e\u003e \"${GITHUB_OUTPUT}\"\r\n\r\n      - name: Cache dependencies\r\n        uses: actions/cache@v3\r\n        with:\r\n          path: ${{ steps.yarn-cache.outputs.YARN_CACHE_DIR }}\r\n          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}\r\n          restore-keys: |\r\n            ${{ runner.os }}-yarn-\r\n\r\n      - run: yarn install --frozen-lockfile\r\n      - run: yarn build\r\n      - run: yarn export\r\n\r\n      - name: Deploy\r\n        uses: peaceiris/actions-gh-pages@v3\r\n        if: ${{ github.ref == 'refs/heads/main' }}\r\n        with:\r\n          github_token: ${{ secrets.GITHUB_TOKEN }}\r\n          publish_dir: ./out\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e上述示例实现打包NextJS应用到运行此action的仓库中，默认推送到gh-pages分支（通过publish_branch选项修改推送分支）。\u003c/p\u003e\n\u003cp\u003e因此实现推送到其他仓库需要修改部分代码\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e      - name: Deploy\r\n        uses: peaceiris/actions-gh-pages@v3\r\n        with:\r\n          personal_token: ${{ secrets.PERSONAL_TOKEN }}\r\n          external_repository: username/username.github.io\r\n          publish_branch: main\r\n          publish_dir: ./out // 推送该指定目录下的文件\r\n          commit_message: ${{ github.event.head_commit.message }}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003epersonal_token\u003c/code\u003e 个人令牌\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eexternal_repository\u003c/code\u003e 其他仓库的地址\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003epublish_dir\u003c/code\u003e 推送该目录下的文件\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecommit_message\u003c/code\u003e 自定义commit信息\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e注意\u003ccode\u003eGITHUB TOKEN\u003c/code\u003e没有访问外部存储库的权限。请创建一个个人访问令牌，并将其设置为secrets，如\u003ccode\u003epersonal_token: ${{ secrets.PERSONAL_TOKEN }}\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e创建个人令牌\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e点击github页面右上角的个人头像，点击Settings\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-6532.3bbea5.webp\" alt=\"\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e点击Developer settings\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-3950.aca4dd.webp\" alt=\"\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e选择页面右下角的Tokens(classic)，点击Generate new token(classic)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-7333.68b538.webp\" alt=\"\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e填写备注信息，选择有效时长，\u003cstrong\u003e勾选repo\u003c/strong\u003e，然后点击下方的Generate token按钮，生成token并复制\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-4107.c474f1.webp\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e将生成的个人令牌绑定到项目的secrets\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e打开运行action的仓库，依次点击Settings-\u003eActions-\u003e New repository secret\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-4506.428fe9.webp\" alt=\"\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eName输入\u003ccode\u003epersonal_token\u003c/code\u003e，Secret粘贴生成的个人令牌，点击Add secret\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-7782.8ec4d7.webp\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e通过上面的配置，我们就可以在action中通过\u003ccode\u003e${{ secrets.PERSONAL_TOKEN }}\u003c/code\u003e访问到个人令牌\u003c/p\u003e\n\u003cp\u003e最后将新建的\u003ccode\u003edeploy.yml\u003c/code\u003e文件提交推送到远程仓库，就会自动触发action执行，构建打包我们的NextJS应用并推送到\u003ccode\u003eexternal_repository\u003c/code\u003e对应仓库的\u003ccode\u003epublish_branch\u003c/code\u003e对应的分支中\u003c/p\u003e\n\u003cp\u003e可以在仓库的Actions中查看action的执行过程，完成后打开GitHub Pages对应的仓库就能看到新提交的代码\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://cdn.jsdelivr.net/gh/shimiyzhang/blog-image/images/23-02-26/clipboard-6478.66382d.webp\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e以上就是本文的全部内容，感谢阅读。\u003c/p\u003e\n","title":"使用Github Actions自动打包部署NextJS应用","date":"2023-02-25"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"使用Github Actions自动打包部署Nextjs应用"},"buildId":"_zcP27D7eUYWJvFDlI-DM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>